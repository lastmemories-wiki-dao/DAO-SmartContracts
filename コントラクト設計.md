# **DAOトレジャリー & タスク決済システム設計まとめ**

## **📌 必要なスマートコントラクト**
以下の **4つのコントラクト** で構成。

---

## **1️⃣ DAOトレジャリー (`DAOTreasury`)**
📌 **役割**  
- DAOの資金管理（ETH・ERC-20）
- タスク報酬の送金（承認済みのもののみ）

🔹 **必要なメソッド**
- `deposit()` → DAOに資金を預ける
- `getBalance()` → DAOのETH残高を確認
- `executePayout(uint taskId, address recipient, uint amount)` → **承認済みのタスク報酬を支払う**
- `isApproved(uint taskId)` → **タスクが承認済みか確認**

---

## **2️⃣ タスク管理 (`TaskManager`)**
📌 **役割**  
- タスク完了報告 & 報酬請求の管理
- 承認状況のトラッキング（決済者が承認するまで）

🔹 **必要なメソッド**
- `reportTaskCompletion(uint taskId, address recipient, uint amount)` → **タスク完了報告 & 報酬請求**
- `approveTask(uint taskId)` → **決済者がタスクを承認**
- `getApprovedAmount(uint taskId)` → **タスクの承認金額を確認**
- `isApproved(uint taskId)` → **タスクが承認済みか確認（DAOトレジャリー向け）**

---

## **3️⃣ 決済者管理 (`PaymentApprover`)**
📌 **役割**  
- 決済者のグレード & 決済可能金額の管理
- 経験値システム（グレードアップ / ダウン）

🔹 **必要なメソッド**
- `registerApprover(address approver, uint grade)` → **決済者を登録**
- `increaseXP(address approver, uint xp)` → **経験値を増やす**
- `decreaseXP(address approver, uint xp)` → **経験値を減らす**
- `getApproverGrade(address approver)` → **決済者のグレードを取得**
- `getAvailableBudget(address approver)` → **決済可能な金額を取得**
- `canApprove(uint taskId, address approver, uint amount)` → **決済者が承認できるか判定**
- `approveTask(uint taskId, address approver)` → **決済者がタスクを承認（制限付き）**

---

## **4️⃣ マルチシグ承認 (`MultiSigApprover`)**
📌 **役割**  
- **決済者の追加・削除をマルチシグで管理**
- **承認に必要な割合（しきい値）をマルチシグで変更**

🔹 **必要なメソッド**
### **🔹 承認者の追加・削除**
- `proposeAddSigner(address newSigner)` → **マルチシグの承認者を追加する提案**
- `proposeRemoveSigner(address signer)` → **マルチシグの承認者を削除する提案**
- `executeAddSigner(uint proposalId)` → **マルチシグ承認後に実行**
- `executeRemoveSigner(uint proposalId)` → **マルチシグ承認後に実行**

### **🔹 承認に必要な割合（しきい値）の変更**
- `proposeChangeThreshold(uint newThreshold)` → **承認に必要な割合を変更する提案**
- `executeChangeThreshold(uint proposalId)` → **マルチシグ承認後に実行**

# **📌 DAOトレジャリーシステムのデータ管理設計**

DAOトレジャリーシステムにおいて、**オンチェーンとオフチェーンで管理するデータ** を整理し、その理由を解説します。

---

## **🔹 オンチェーン vs オフチェーンの判断基準**
### **✅ 1. オンチェーン管理するべき情報**
- **セキュリティと透明性が必要なデータ**
- **決済や資金管理など、トラストレスに動作する必要があるもの**
- **スマートコントラクトが直接参照する必要があるもの**

### **✅ 2. オフチェーン管理するべき情報**
- **頻繁に変更されるデータ（ガスコスト削減）**
- **詳細なメタデータ（説明、議論ログなど）**
- **分析や履歴データ（外部のダッシュボード用）**

---

# **📌 各コントラクトのデータ管理方針**
## **1️⃣ DAOトレジャリー (`DAOTreasury`)**
📌 **役割** → DAOの資金管理 & 承認済みタスクの報酬支払い

| データ | **管理場所** | **理由** |
|--------|------------|----------|
| **DAOの資金残高（ETH・ERC-20）** | **オンチェーン** | 透明性を確保し、DAOのメンバーが資金状況を確認できるようにするため |
| **報酬支払いの履歴** | **オンチェーン** | 不正防止のため、誰がどのタスクに対していくら支払ったかをブロックチェーン上で記録する |
| **タスクの承認状況** | **オンチェーン** | `TaskManager` から承認状況を確認し、適切な支払いを行うため |
| **支払いの詳細なログ（説明など）** | **オフチェーン** | 説明文や詳細なレポートはオンチェーンに保存する必要がなく、外部DBやダッシュボードで管理した方が効率的 |

---

## **2️⃣ タスク管理 (`TaskManager`)**
📌 **役割** → タスクの報酬請求 & 承認フローの管理

| データ | **管理場所** | **理由** |
|--------|------------|----------|
| **タスクIDと請求情報** | **オンチェーン** | DAOの資金から支払いを行うため、請求情報を信頼性のあるデータとして保存する必要がある |
| **タスクの承認状況** | **オンチェーン** | `DAOトレジャリー` が承認済みかを参照できるようにするため |
| **タスクの詳細情報（内容・完了報告など）** | **オフチェーン** | 文章や画像などのメタデータはガスコストが高いため、オフチェーンで管理する方が効率的 |
| **承認プロセスの詳細ログ** | **オフチェーン** | どの決済者が承認したかの記録をオフチェーンで管理し、必要に応じて参照可能にする |

---

## **3️⃣ 決済者管理 (`PaymentApprover`)**
📌 **役割** → 決済者のグレード & 決済可能金額を管理

| データ | **管理場所** | **理由** |
|--------|------------|----------|
| **決済者リスト (`approvers`)** | **オンチェーン** | 誰が決済者であるかを明確にし、不正な決済を防ぐため |
| **グレード (`grades`)** | **オンチェーン** | 決済者の権限を制限するために必要 |
| **毎月の決済可能金額 (`monthlyLimit`)** | **オンチェーン** | 決済者がどの範囲で承認できるかを制限するため |
| **その月の決済合計 (`spentThisMonth`)** | **オンチェーン** | 各決済者が決済可能金額を超えないようにするため |
| **経験値 (`XP`)** | **オフチェーン** | 頻繁に変更が発生し、オンチェーンに保存するとガスコストがかかるため |
| **決済者の貢献履歴** | **オフチェーン** | ログとして残すが、ブロックチェーンで保持する必要はない |
| **グレードアップ・ダウンの計算** | **オフチェーン** | 計算はオフチェーンで実施し、変更時のみオンチェーンへ書き込む |

---

## **4️⃣ マルチシグ承認 (`MultiSigApprover`)**
📌 **役割** → 決済者の追加・削除 & マルチシグのしきい値変更を管理

| データ | **管理場所** | **理由** |
|--------|------------|----------|
| **承認者リスト (`signers`)** | **オンチェーン** | 誰が承認者であるかを明確にし、不正な操作を防ぐため |
| **マルチシグの承認しきい値 (`approvalThreshold`)** | **オンチェーン** | 何人の承認が必要かをトラストレスに管理するため |
| **提案された変更 (`proposals`)** | **オンチェーン** | 提案内容が改ざんされないようにするため |
| **各提案の承認状況 (`approvals`)** | **オンチェーン** | どの提案が承認されたかを正しく追跡するため |
| **過去の承認・拒否ログ** | **オフチェーン** | 承認プロセスの履歴を記録するが、ブロックチェーンに残す必要はない |
| **変更の提案理由・議論の記録** | **オフチェーン** | 文章などのデータは外部DBやフォーラムで管理する方が効率的 |

---

